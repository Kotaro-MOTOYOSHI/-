%#####################################################################
\chapter{ns-3によるOpenFlowネットワーク構築}
%#####################################################################

% 森定さんの内容
\begin{comment}
　本節では，今回の研究で再現した来年度実装予定である次期EUNETの概要とns-3におけるネットワーク構築法，パラメータ設定に関して説明する．

\section{EUNET概要}

EUNETの構築に必要なのは愛媛大学の城北，重信，持田，樽見の各キャンパスとデータセンターを接続するネットワーク（以降「L3サブネット」）と
キャンパス内の建物同士を接続するネットワーク・建物内を網羅するネットワーク（以降「エッジネットワーク」）の二種類である．以降で詳細な説明と，各ネットワークの配置等の説明を行う．

EUNETにおけるネットワークの構築内容を図 \ref{EUNET構成図} で表し，エッジネットワークにおける機器の総数を表 \ref{各キャンパスのネットワーク機器数} に表す．

\begin{figure}[tb]
\begin{center}
\scalebox{0.7}{\includegraphics{ネットワーク構成図.eps}} 
\caption{EUNET構成図}
\label{EUNET構成図}
\end{center}
\end{figure}

\begin{table}[tb]
\begin{center}
\caption{各キャンパスのネットワーク機器数}
\label{各キャンパスのネットワーク機器数}
\begin{tabular}{c|c|c|c} 
\hline \hline
キャンパス名 & L3スイッチ & L2スイッチ & 無線アクセスポイント \\ 
\hline 
城北 & 26 & 180 & 167 \\
重信 & 12 & 90 & 60 \\
樽見 & 8 & 44 & 68 \\
持田 & 4 & 10 & 13 \\
\hline
\end{tabular}
\end{center}
\end{table}


\subsection{L3サブネット}
L3（レイヤ3）スイッチ（以降「コアスイッチ」）群，および，次に説明するスーパーコアから構成される愛媛大学の各キャンパスを接続するネットワーク．\\

\subsubsection{コアスイッチ}

データセンタ，城北，重信，樽見，持田の各キャンパスに設置され，各キャンパスは10Gbps2回線により接続が行われている．
コアスイッチ間の回線接続はこの冗長接続で行われ，物理的に二重化（2回線による冗長接続）し，合計20Gbpsの回線容量を持たせて構築している．
構築の際，一方の回線に障害が発生しても10Gbpsの回線容量を維持できるようになる．
コアスイッチは認証機能を持ち，認証された機器とのみ通信を行う．\\


\subsubsection{スーパーコア}

L3サブネットの中核を成すネットワーク機器群．愛媛大学ネットワークとインターネットとの接続点．ファイアウォール，検疫ゲートウェイ，侵入防御システム（IPS），セキュアゲートウェイの機能を持つ．
%スーパーコアに設置されるファイアウォールはUDP通信に対して，ステートフルパケットインスペクション（SPI），および，アプリケーションレイヤーパケットインスペクション（ALPI）と同等以上の機能を備えている．
%加えてパケットインスペクションの同時セッション数は1,000,000 以上である．
%検疫ゲートウェイのネットワークへの接続は10Gbps 以上の通信規格を有する回線で行い，障害が発生した場合でも，正常時の半分以上の性能を維持できる冗長構成となっている．
%侵入防御システムは全てのVLANのトラヒックを同時に監視する機能を有している．
%セキュアゲートウェイは，認証情報に基いて外部からEUNET内部にアクセスする機能を備えており，同時接続可能なセッションは10,000以上である．外部からの接続を行う場合，IPsec等盗聴防止機能を備える．

ファイアウォール機器はここに設置され，不正接続制御を行う．加えて検疫ゲートウェイを持ち，通過するトラヒックに対してディープパケットインスペクションにより，ウィルス，ワーム，トロイの木馬，アプリケーションアタック，バッファオーバーフロー，スパイウェアなど情報ネットワーク上の情報システムに悪影響を与える可能性があるものについて遮断を行う機能を備える．\\


\subsection{エッジネットワーク}
エッジネットワークは各キャンパス内に存在する建物等を網羅し，ユーザが使用する端末がEUNETに接続できるようにするネットワークである．
エッジネットワークにおいては，複数のL3スイッチ，L2スイッチ，アクセスポイントが相互接続されており，各機器の先にホストを接続する事で有線・無線が混在した環境が構成される．

% \subsubsection{無線アクセスポイント}

% 無線アクセスポイントを用

\section{ネットワーク構築手順}

ns3を用いたネットワークの構築に関する説明を行う．
今回の研究では，ns3に用意されているメソッドを組み合わせ，必要な機能を満たすクラスを作成し，組み合わせることで各ネットワーク機器を表現し，ネットワーク構築を行う．

\begin{figure}[bt]
\begin{center}
\scalebox{0.5}[0.5]{\includegraphics{クラス継承図.eps}} 
\caption{クラス継承図}
\label{クラス継承図}
\end{center}
\end{figure}

各クラスの継承関係は図 \ref{クラス継承図} のようになっている．
次に，各クラスの機能について説明していく．\\

\subsection{EUNET構築のためのクラス}
ここでは，EUNETのシミュレーションモデル作成に利用する各クラスの動作を説明する．
実際のコードは付録参照．

\subsubsection{CsmaNode}

CsmaNodeクラスはns3に用意されているnodeクラスを継承している．各デバイスのためのノードを作成し，シミュレータにおけるログの出力に関する設計を行う．
他に，自身の作成したノードの種類を判別し，出力することが可能．

ログは，シミュレーション結果から細かく種類分けされて出力される．
大きく分けて，送信前の端末上で発生したTCP/IPの各層におけるデータの受け渡しに関するログ，
回線を用いた送受信で発生したパケットロスや伝送遅延に関するログ，
受信側の端末で発生したTCP/IPの各層におけるデータの受け渡しに関するログの三つが存在する．\\

\subsubsection{CsmaChannelNode}

CsmaChannelNodeクラスはCsmaNodeクラスを継承し，ノード間の接続に関する設定を行う．
回線のパラメータとしてデータ転送速度，遅延時間を設定を行い，ノード（端末）に対して別の端末を接続を行うbring機能を表現する．\\

\subsubsection{CsmaInternetNode}

CsmaInternetNodeはCsmaChannelNodeを継承し，EUNETにおける端末（PC）のインターネット接続に関する設定を行い，端末がインターネットを用いたデータの送受信に関する設定を行う．
今回のシミュレーションモデル構築では，IPv4を用いたインターネットへの接続のみを行い，IPv6に関しては構築を行わない．

ns3上でインターネットへの接続を表現する場合，ns3に用意されているinternet-moduleクラスを用いる必要があり，
このクラスを用いる事で各PC端末を表現するノードに対してIPv4のアドレス割り当て等，インターネットへ接続する際に必要な機能の設定を行う．\\

\subsubsection{PacketSinkNode}

PacketSinkNodeクラスはCsmaInterNetNodeクラスを継承し，ノードが受け取ったパケットの解析・処理に関する設定を行う．

ノードにおけるIPアドレスとポート番号を用いてパケットの受信を行い．受信したパケットのサイズ・送信元のアドレスを行う．
シミュレーションでは不明なアドレスからのパケット受け取りは考慮しないため，シミュレーション開始前に全ての端末を把握していると仮定している．\\

\subsubsection{OnOffNode}

OnOffNodeクラスはPacketSinkクラスを継承し，ノードが宛先端末に対しトラヒックを生成する機能を付加する．

このクラスを継承し，パケットの送信を行うよう設定された端末は，シミュレーション開始直後から終了の入力が行われるまで設定された宛先までトラヒックを生成する．
送信するパケットはオン時間とオフ時間のランダム変数から生成され，オン状態の場合に指定されたデータレートとパケットサイズに従ったパケットとなる．
このクラスまでを継承する事でシミュレータ上での端末としての基本的な動作を行う事が可能になる．\\

\subsubsection{EunetTerminal}

EunetTerminalクラスはOnOffNodeクラスを継承し，EUNETにおける端末の特徴を記述するために用意したクラスである．
端末作成時に接続された端末があるかを検査する．\\

\subsubsection{EunetTerminals}

EunetTerminalsクラスはns3に用意されているNodeContainerクラスを継承し，EUNETにおける端末を複数作成，アドレスの割り当て等を行う．
このクラスを用いて作成された端末は，IPv4アドレスを割り当てられ，指定した端末同士の接続を行う機能を持つ．\\

\subsubsection{SimpleSwitch}

SimpleSwitchクラスはCsmaChannelNodeクラスを継承し，L2スイッチとしての機能を表現する．

機器との接続を行い，その際回線速度，遅延時間を個別に設定する事が可能．回線速度と遅延時間により機器の性能を表現する．
L2スイッチ同士での接続，L3スイッチとの接続を行うことも可能．
ポート数を指定する事も可能で，ポート数を指定し，仕様書に基づいて接続を行うことでEUNETを再現していく．\\

\subsubsection{EunetSwitch}

EunetSwitchクラスはSimpleSwitchクラスを継承し，EUNETにおけるスイッチの特徴を記述するために用意したクラスである．
スイッチにおけるトレースファイルの出力はここで表現される．トレースファイルはL2スイッチにおける各ポートに個別設定を行うことが可能で，指定したポートに関してのみファイル出力が行えるようになっている．
ポート自体にファイル出力機能を付加する事ができないので，L2スイッチ作成時に空きポートにはPacketSinkアプリケーションを持ったEunetTerminalクラスで定義した端末を作成し，そこでパケットに関するログを取得する．\\

\subsubsection{EunetSwitches}

EunetSwitchesクラスはns3にあるNodeContainerクラスを継承し，EUNETを再現するためにn分木のような形にEunetSwitchクラスで表現されているL2スイッチを接続していくクラスである．\\
引数として深さ，幅を指定する事で木構造的にL2スイッチを複数作成する事が可能．


\subsubsection{NamedSwitches}

NamedSwitchesクラスはEunetSwitchesクラスを継承し，スイッチに名前を付ける事を可能とするクラスで，スイッチをIPアドレス等ではなく，名前で管理する事が可能となる．\\
EunetSwitchクラスで表現されるスイッチを含め，全てのノードはシミュレータ上ではトポロジの作成時に行われる番号付けにより独自の通し番号で管理されるが，デバイスの作成順に番号が付けられるだけであり，これはトポロジを作成しなおすだけで変更されてしまう．
そのため人間が一意に端末を指定する事が難しく，シナリオを作成する事が困難であるので，EunetSwitchに名前付け空間を用意し，指定した名前を持つスイッチを作成可能にした．
このクラスによって記述されたスイッチは，シミュレータ上でその名前を使って指定する事が出来るだけでなく，ログの出力にも名前を表示する事が出来る．\\

\subsubsection{SimpleRouter}

CsmaChannelNodeクラスを継承し，一般的なルータを表現する．
このクラスではDCEを用いてQuaggaデーモンを利用し，実際に利用されるルーチンアルゴリズムを使用するルータを表現する．
このアルゴリズムは，シミュレーション内部で処理を行う．

ルータに接続される端末への回線速度と遅延，接続ポートの管理，IPv4でのパケットルーチングの設定等を行う．
ここで設定を行ったルータに接続された端末から送信されるパケットは，Quaggaデーモンに基づいて実際のパケットと同様に処理される．\\

\subsubsection{EunetRouter}

SimpleRouterクラスを継承し，EUNETにおいて使用されるルータの設定を記述するためのクラスである．\\
\end{comment}

% 自分の内容
　本節では，現在愛媛大学が採用しているEUNETについて説明し、今回の研究で提案するOpenFlowを用いたネットワークモデルの構築法について説明する。

\section{EUNET}

現在、愛媛大学ではEUNETと呼ばれるネットワークが稼働している。
EUNETは大きく分けると、キャンパス内を網羅するエッジネットワークと、愛媛大学の城北、重信、樽味、持田の各キャンパスとデータセンタを接続するL3サブネットの二種類がある。

\subsection{L3サブネット}

EUNETの中心部に位置するネットワーク。
愛媛大学の各キャンパス及びデータセンタに設置されているコアスイッチ群、以下に説明するスーパーコアから構成され、愛媛大学の各キャンパス間の接続およびインターネットとの接続を行う。

\subsubsection{スーパーコア}

L3サブネットの中核を成すネットワーク機器群。
EUNETとインターネットとの接続点に設置されており、ファイアウォール、検疫ゲートウェイ、侵入防御システム(IPS)、セキュアゲートウェイの機能を持ち、EUNETに悪影響を与える可能性のある通信について対応する機能を備える。
インターネットなど外部との接続の場合のみならず、EUNET内部でも異なるセグメント間の通信は、必ずスーパーコアを通るような設計になっており、ネットワーク内部の脅威にも対応することが可能である。

しかし、現在のスーパーコアの設計は、
これにより、検疫ゲートウェイ兼侵入防御システムは、パケットの入力ポートおよび出力ポートを明確に規定され、

\section{ネットワークモデル構築法}

本節では、上記の問題点があるスーパーコアを改善したネットワークモデルを構築する方法を説明する。

% スイッチをOpenFlowスイッチへと変更してL3サブネットを構成し、2種類のOpenFlowコントローラによってスイッチを制御することで、以下の図 \ref{fig:3-1}のようなネットワークを構築する。
スイッチをOpenFlowスイッチへと変更してL3サブネットを構成し、2種類のOpenFlowコントローラによってスイッチを制御することで、以下の図のようなネットワークを構築する。

% \begin{figure}[tb]
% \begin{center}
% \scalebox{0.3}{\includegraphics{重信トポロジ.eps}} 
% \caption{エッジネットワーク（重信キャンパス）}
% \label{fig:3-1}
% \end{center}
% \end{figure}

次に、2種類のOpenFlowコントローラについて説明する。

\subsection{BasicController}

OpenFlowスイッチとIPS間、および